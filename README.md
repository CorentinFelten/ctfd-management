# CTFd Infrastructure

The purpose of this repository is to propose a simple setup and challenge management tool for CTFd infrastructures. It has been tested and validated on  [PolyCyber](polycyber.io)'s CTFd infrastructures (PolyPwn2025, PolyPwn2026, as well as the internal CTFd for PolyCyber).

## Available Scripts

### 1. CTFd Installation Script (`setup.sh`)

Bash script that automates the installation and configuration of a CTFd server using the [Zync](https://github.com/28Pollux28/zync) plugin and its dedicated instancer [Galvanize](https://github.com/28Pollux28/galvanize).

### 2. Challenge Management Tool (`challenges_management.sh`)

Bash script for building, ingesting, and synchronizing CTF challenges with support for Docker containers and Docker compose.

# Prerequisites

## For the CTFd installation script

- **Operating System**: Tested and verified on:
  - Ubuntu Server 24
  - Ubuntu Server 25
  - Debian 12
- **Privileges**: The script must be executed as root (automatically uses sudo if necessary)

## For the challenge management tool

- **Docker**: Installed and functional
- **curl, jq, yq**: For API calls and YAML/JSON processing (automatically verified)
- **Challenge repository**: Folder structure with `challenge.yml` files

# CTFd Server Installation

1. **Clone this repository**:
   ```bash
   git clone https://github.com/CorentinFelten/infra
   cd infra
   ```

2. **Run the installation script and follow the instructions**:
   ```bash
   ./setup.sh --domain <your-domain.com>
   ```

3. **Go to the configured server URL**
   - Configure the CTF event
   - Navigate to the admin configuration panel: `Admin Panel` --> `Plugins` --> `Zync Config`
   - Enter your Galvanize instancer's URL and JWT secret generated by the setup

## Installation Script Options

| Option                   | Description                                                      | Required |
|--------------------------|------------------------------------------------------------------|----------|
| `--domain domain/IP`      | URL/domain of your CTFd server                                   | ✅ Yes   |
| `--working-folder DIR`   | Working directory (default: `/home/$USER`)                       | ❌ No    |
| `--theme DIR/URL`        | Enables the use of a personalised theme                          | ❌ No    |
| `--backup-schedule TYPE` | Database backup frequency (`daily` (default), `hourly`, `10min`) | ❌ No    |
| `--no-https`             | Deployment without HTTPS                                         | ❌ No    |
| `--help`                 | Display help                                                     | ❌ No    |

## Installation Examples

```bash
# Basic installation with domain
./setup.sh --domain example.com

# Basic installation with IP address - automatically uses the --no-https option
./setup.sh --domain 192.168.123.123

# Installation with custom directory
./setup.sh --domain example.com --working-folder /opt/ctfd

# Installation with custom theme
./setup.sh --domain example.com --theme  /home/user/my-custom-theme

# Installation with custom theme downloading a theme directly from github 
./setup.sh --domain example.com --theme https://github.com/user/theme.git

# Hourly backup
./setup.sh --domain example.com --backup-schedule hourly

# Backup every 10 minutes
./setup.sh --domain example.com --backup-schedule 10min

# Display help
./setup.sh --help
```

## Custom theme configuration

If you use the `--theme` option, the script will automatically mount the custom theme folder in the `docker-compose.yml`. 

# Challenge Management Tool

## Available Actions

| Action    | Description                     |
|-----------|---------------------------------|
| `all`     | Build + ingest (default)        |
| `build`   | Build Docker images only        |
| `ingest`  | Ingest challenges into CTFd     |
| `sync`    | Synchronize existing challenges |
| `status`  | Display status and statistics   |
| `cleanup` | Clean up Docker images          |

## Main Options

| Option                 | Description                                                             | Required |
|------------------------|-------------------------------------------------------------------------|----------|
| `--ctf-repo REPO`      | Name of the challenge repository present in the working directory       | ✅ Yes   |
| `--action ACTION`      | Action to perform (all (default), build, ingest, sync, status, cleanup) | ❌ No    |
| `--working-folder DIR` | Working directory (default: `/home/$USER`)                              | ❌ No    |
| `--config FILE`        | Load configuration from a file                                          | ❌ No    |

## Filtering Options

| Option              | Description                                              |
|---------------------|----------------------------------------------------------|
| `--categories LIST` | List of categories to process (comma-separated)          |
| `--challenges LIST` | List of specific challenges to process (comma-separated) |

## Behavior Options

| Option                | Description                                            |
|-----------------------|--------------------------------------------------------|
| `--dry-run`           | Simulation mode (shows actions without executing them) |
| `--force`             | Force operations (rebuild, overwrite)                  |
| `--parallel-builds N` | Number of parallel builds (default: 4)                 |

## Debug Options

| Option                | Description                 |
|-----------------------|-----------------------------|
| `--debug`             | Enable debug output         |
| `--skip-docker-check` | Skip Docker daemon check    |
| `--help`              | Display help                |
| `--version`           | Display version information |

## Challenge Management Examples

```bash
# Full configuration (build + ingest)
./challenges_management.sh --ctf-repo challenge_repo

# Build only for certain categories
./challenges_management.sh --action build --ctf-repo challenge_repo --categories "web,crypto"

# Synchronization with forced update
./challenges_management.sh --action sync --ctf-repo challenge_repo --force

# Simulation mode to see planned actions
./challenges_management.sh --ctf-repo challenge_repo --dry-run

# Processing specific challenges
./challenges_management.sh --action build --ctf-repo challenge_repo --challenges "web-challenge-1,crypto-rsa"

# Parallel build with 8 threads
./challenges_management.sh --action build --ctf-repo challenge_repo --parallel-builds 8

# Display status
./challenges_management.sh --action status --ctf-repo challenge_repo

# Clean up Docker images
./challenges_management.sh --action cleanup --ctf-repo challenge_repo
```

### Configuration File

Create a `.env` file with `KEY=VALUE` pairs:

```bash
CTF_REPO=challenge_repo
WORKING_DIR=/opt/ctf
PARALLEL_BUILDS=8
FORCE=true
DEBUG=false
```

Usage:
```bash
./challenges_management.sh --config .env
```

# Script Functionality

## CTFd Installation Script

### 1. System Update
- Update system packages
- Install dependencies

### 2. Docker Installation
- Add official Docker repository
- Install Docker CE, Docker Compose, etc.
- Configure user groups

### 3. Theme configuration (optionnal)
If the `--theme` flag is used:
- Mounts the `theme/custom/` folder in the CTFd container
- Enables the use of custom themes

## Challenge Management Tool

### 1. Dependency Check
- Verify Docker and daemon availability
- Check for required system tools (curl, jq, yq)

### 2. Challenge Discovery
- Analyze the challenge repository structure
- Identify Docker and static challenges

### 3. Docker Image Building
- Sequential or parallel image building
- Support for `--force` mode for complete rebuild
- Error handling with detailed reports

### 4. Challenge Ingestion
- Installation via the CTFd API into the CTFd instance

### 5. Synchronization
- Update existing challenges
- Option to backup before synchronization
- Support for `--force` mode for overwriting

### 6. Cleanup
- Remove Docker images associated with challenges
- Dry-run mode available

# Challenge Structure

## Expected Challenge Repository

```
challenge_repo/
├── challenges/                    # (optional, detected automatically)
│   ├── web/
│   │   ├── challenge-1/
│   │   │   ├── challenge.yml      # Challenge configuration
│   │   │   ├── Dockerfile         # Docker image (for type: zync)
│   │   │   ├── src/               # Source code
│   │   │   └── files/             # Challenge files
│   │   └── challenge-2/
│   ├── crypto/
│   └── pwn/
```

> [!WARNING]
> The challenge ingestion script works in alphabetical order of categories and challenges. If a challenge has prerequisites, it is necessary to ingest the prerequisites beforehand by naming it appropriately.

### Format of the `challenge.yml` File

```yaml
name: "MyChallenge"
author: Challenge_Author
category: AI

description: |-
  ## Description (French)

  Petite description en français

  ## Description (English)

  Short description in English

flags:
  - flag{flag_to_find}

tags:
  - AI
  - A:Challenge_Author

requirements:
  - "Rules"

# If files needed
files:
  - "files/hello_world.txt"

# If hints needed, choose the cost
hints:
  - Interesting hint
  - {
    cost: 10,
    content: "Interesting payed hint"
  }

value: 5
type: zync                            # or type: dynamic / static

# Following options are for type: zync only. See https://github.com/28Pollux28/galvanize/blob/master/data/challenges/example/challenge.yml for up-to-date config

playbook_name: http                   # Use 'http' for web challenges, 'tcp' for TCP challenges, or 'custom_compose' for custom Docker Compose setups
deploy_parameters:
  image: nginx:alpine                 # Docker image to deploy
  unique: false                       # Set to true if there needs to be a unique instance for all players
  published_ports:                    # Ports to expose from the container (Only for 'tcp' playbooks)
    - 80                              # Port to expose:
  compose_definition: |-              # Docker Compose definition (Only for 'custom_compose' playbooks)
    version: '3'
    services:
      web:
        image: nginx:alpine
        ports:
          - "80:80"
  env:                                # Environment variables passed to the container
    FLAG: "flag{flag_to_find_in_env}"
    TZ: Europe/Zurich
```

## Generated Configuration

The setup script automatically generates:
- **CTFd secret key** (32 characters)
- **Database password** (16 characters)
- **Database root password** (16 characters)

These scripts were initially developed for the PolyCyber team to automate the installation and management of CTFd servers. They were built to work specifically with the [Galvanize](https://github.com/28Pollux28/galvanize) instancer and [Zync](https://github.com/28Pollux28/zync) plugin. 